
hint_systemd(){
  service=/etc/systemd/system/$PODI_APP.service
  silent which podman || return 0
  test -f $service    && return 0
  silent podman inspect $PODI_APP || return 0
  podman generate systemd $PODI_APP > $PODI_APP.service
  print "to survive server-reboots please run as root:"
  echo "cp $(pwd)/$PODI_APP.service /etc/systemd/system/." | soften
  echo "systemctl enable $PODI_APP.service" | soften
}

build(){
  header .pod/app/container
  test -f Dockerfile || { print "'Dockerfile' not found..skipping build"; }
  test -f Dockerfile && {
    silent which $container || print '[!] please install podman (or docker)'
    silent which $container && verbose $container build -t $PODI_APP .
  } | soften 
  return 0
}

daemonize(){
  while sleep 0.2s; do 
    set +e
    POD=$(which podman || which docker)
    nc 2>&1 | silent grep BusyBox || NCARG="-N"
    echo "starting $PODI_APP TTL=$TTL BOOTTIME=$BOOTTIME"
    test -z $($POD ps -a --filter=name=$PODI_APP| head -n-1) && ./app 
    $POD start $PODI_APP
    sleep $TTL
    $POD stop $PODI_APP 
    echo sleeping on port $PORT
    echo "HTTP/1.1 302 OK\nrefresh:$BOOTTIME;url=/\n\n" | nc $NCARG -lp $PORT | awk '{ printf "\r",$0 }'
  done
}

start(){
  header .pod/app/container
  POD=$(which podman || which docker || echo "")
  silent which $POD || error "please install podman (or docker)"
  test -f .pid  && { print "stopping $PODI_APP"; silent try kill -15 $(cat .pid); }
  test -z $POD || {
    silent try $POD kill $PODI_APP
    silent try $POD rm -f $PODI_APP
    export PODI_APP=$PODI_APP
    export PODI_GITPUSH=$PODI_GITPUSH
    eval "$(cat .env)"
    { nohup ./podi daemonize $PODI_APP:$PORT 1> app.log 2> app.log; } &
    echo $! > .pid
    hint_systemd
    print ""
    print "started container $PODI_APP [PID $(cat .pid)] on $PODI_REMOTE:$PORT"
    print "autosleeping after $TTL seconds (.env)"
    print "waking up after network request on port $PORT"
  } 
  return 0
}

init_runtime(){
  test -f app || {
    generate(){ 
      echo '#!/bin/sh'
      echo 'test -z $PODI_APP  && PODI_APP=$(basename $(pwd))' 
      echo 'test -f Dockerfile && IMAGE=$PODI_APP || IMAGE=docker.io/coderofsalvation/redbean:1.5'
      echo 'CMD="/redbean.com -D . -p 80 -vv"'
      echo 'POD=$(which podman || which docker)'
      echo 
      echo '$POD run -d --rm --volume $(pwd):/home/app -w /home/app -e PORT -p $PORT:80 --name $PODI_APP $IMAGE $CMD' 
      echo '$POD logs $PODI_APP 2>&1 | awk "{print \"[app.log] \"\$0 }"'
    }
    prompt "generate + commit 'app' startfile?" "$(generate | soften)" "[y/n] "
    test $answer = "y" || error aborting
    generate > app 
    chmod 755 app 
    git add app && git commit -m "podi: adding app file"
  }
  test -f .pod/extract/rollback_simple || recipe extract/rollback_simple
  test -f .pod/start/envfile           || recipe start/envfile 
  test -f .pod/init/server/sshkey      || recipe init/server/sshkey 
  echo "export TTL=5        # suspend after 5 seconds of activity (update me!)" >> .env
  echo "export BOOTTIME=2   # give app 2 second to wakeup         (update me!)" >> .env
}
