container=$(which podman || which docker || echo echo podman )

create_container_app(){
  header .pod/app/container 
  test -f Dockerfile || {
    print "writing Dockerfile"
    echo "FROM busybox:latest" > Dockerfile
  }
  test -f app || {
    print "writing app"
    echo '#!/bin/sh\necho "PID=$(cat .pid) => $(date) PORT=$PORT"' > app
    chmod 755 app
  }
  test -f .env || {
    print "writing .env"
    PORT=$(awk 'BEGIN{ srand(); print int(rand()*1000)+8000 }')
    echo 'export PORT='$PORT   >> .env
  }
}

build(){
  header .pod/app/container
  $container build . -t $PODI_APP
}

start(){
  header .pod/app/container
  $container kill $PODI_APP
  $container rm -f $PODI_APP
  $container run -d --rm -v $(pwd):/app -w /app -e PORT -p $PORT:80 --name $PODI_APP $PODI_APP ./app
}

on init_localhost create_container_app
